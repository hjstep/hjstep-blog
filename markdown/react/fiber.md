---
title: '파이버 아키텍쳐'
date: 2024-01-29
summary: '리액트 렌더링 아키텍쳐인 파이버에 대해서'
tag: [react]
---

# 리액트 파이버
React 16에 등장한 가상 DOM을 이용하여 렌더링 과정을 최적화하기 위한 아키텍처다.

- 비동기적으로 렌더링 작업 처리 가능 
  - 렌더링 작업을 일시중단/다시 시작/폐기 가능
- Incremental Rendering(단계적 렌더링)
  - 렌더링 작업을 작은 단위로 쪼개어 분할할 수 있다.
- 우선순위
  - 렌더링 작업에 우선순위를 매길 수 있다.

## 파이버 작업
트리 업데이트 과정을 파이버 단위로 나눠서 수행한다.

1. 변경 감지 : 컴포넌트의 props나 state 변경 감지
2. WorkInProgress 트리 생성 : current 트리를 기반으로 생성한다 (파이버노드 재사용)
3. WorkInProgress 트리에 업데이트 적용 : 업데이트 사항이 WorkInProgress 트리의 각 파이버노드에 적용됨
4. Diffing 알고리즘 적용 : 실제 DOM에 필요한 변경사항을 최소화하기 위해 Diffing 알고리즘을 적용하여 current와 workInProgress를 비교한다.
5. 커밋 단계 : 더블 버퍼링 메커니즘으로, current 트리를 workInProgress 트리로 교체한다. 그리고 이 트리가 UI에 최종적으로 렌더링되어 반영된다.

## 파이버 (FiberNode 생성자함수에 의해 생성된 인스턴스)
- 하나의 element 마다 생성됨
- 파이버간의 관계는 child, sibling, return, index 프로퍼티로 표현
- alternate : 반대편 트리 파이버를 가리킴

## 파이버 트리 2개
1. current 트리 : 현재 화면에 렌더링된 UI 트리
2. workInProgress 트리 : 업데이트가 진행중인 상태를 나타내는 트리

# 파이버 아키텍처 기반의 리액트 렌더링 프로세스

### **렌더 단계**

1. **workInProgress 트리 생성**:
    - 렌더 단계가 시작되면, **`current`** 트리의 복사본으로 **`workInProgress`** 트리가 생성된다.
2. **workInProgress 트리 탐색**:
    - 리액트는 **`workInProgress`** 트리를 루트부터 업데이트가 필요하다고 지정돼있는 모든 컴포넌트들을 탐색한다. 변경이 필요한 컴포넌트를 발견하면(변경 감지) 클래스형 컴포넌트이면 **`render`** 메서드 또는 함수형 컴포넌트이면 `**함수 자체**`가 호출되어 반환된 결과(render() 또는 return)가 workInProgress 트리의 해당 파이버 노드로 저장된다. 이런식으로 탐색하여 모든 변경사항을 workInProgress 트리에 반영한다.
3. **리액트의** **재조정 과정(Reconciliation)**: DOM 반영이 필요한 컴포넌트를 체크하는 단계
    - 효율적으로 최소한의 DOM 업데이트를 하기위해 재조정 과정을 거친다.
     **`workInProgress`** 트리와 **`current`** 트리 사이에서 type, key, props를 기준으로 변경 사항을 식별한다.(type, key가 변경되면 새로운 노드를 생성하고, 만약 type, key가 동일하다면 props 변경을 기준으로 식별)
        - **Fiber 노드에 효과 태그로 업데이트 표시**:
        각 **`Fiber`** 노드를 검사한다.  변경이 필요한 파이버 노드에 효과 태그를 할당한다(추가, 삭제, 업데이트에 따라 효과태그가 다름)
        - **업데이트 큐**:
        변경이 감지된 컴포넌트의 **`Fiber`** 노드에 업데이트 큐를 생성하거나 업데이트한다. 이 업데이트 큐에는 상태 변경, props 변경 등의 정보가 포함될 수 있다.
        - **효과 리스트(Effect List)**:
        효과 태그가 할당된(변경 사항이 체크된) **`Fiber`** 노드는 효과 리스트(Effect List)에 추가됩니다. 이 효과 리스트는 커밋 단계에서 실제 DOM에 적용할 변경 사항들의 목록을 나타냅니다.
4. **렌더 단계 완성**:
    - `**workInProgress`** 트리에 모든 변경사항이 적용되고 필요한 업데이트가 계산되면 렌더 단계가 완성되며, **`workInProgress`** 트리는 커밋 단계로 넘어갈 준비가 된다.
5. **중단 및 재개**: 리액트 파이버는 렌더단계를 비동기로 작동하게 할 수 있음(이게 스택조정자는 동기였음)
    - 리액트는 렌더단계를 비동기로 작동해 특정 렌더링의 우선순위를 낮추거나, 중단, 재시작, 폐기할 수 있다.
        - 이를 통해 브라우저의 동기 작업을 차단하지 않고 백그라운드에서 새로운 리액트 트리를 준비할 수도있으므로 사용자는 더욱 매끄러운 UX를 누릴수있다.

### **커밋 단계**

1. **실제 DOM에 변경 사항 렌더링**:
    - 효과 리스트를 순회하며, 각 **`Fiber`** 노드에 표시된 변경 사항을 실제 DOM에 반영한다.
2. **current 트리로 교체**:
    - DOM 업데이트가 완료되면, **`current`** 트리는 **`workInProgress`** 트리로 교체된다.
    (모든 DOM 노드 및 인스턴스를 가리키도록 리액트 내부의 참조를 업데이트함)
3. **라이프사이클 메소드 및 후크 호출**:
    - 클래스형 컴포넌트의 경우, 라이프사이클 메서드(**`componentDidMount`**, **`componentDidUpdate`**)를 호출한다. 함수형 컴포넌트의 경우, **`useLayoutEffect`**훅을 호출한다.

> 리액트의 렌더링이 일어난다고 해서 무조건 DOM 업데이트가 일어나는것은 아니다.
> 렌더단계에서 변경사항을 계산했는데 아무런 변경사항이 감지되지 않는다면 커밋단계는 생략될 수 있다.